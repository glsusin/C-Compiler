<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebAlgo Web</title>
    <!-- Inclua o CSS do CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.1/codemirror.min.css">
    <!-- Escolha um dos temas do CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.1/theme/dracula.min.css">
    <!-- Addon for Autocomplete -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.1/addon/hint/show-hint.min.css">
    <!-- Boostratp 5.3.3 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Material Icon -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="includes/css/main.css">
  <script>
      function mostra_tela_aguarde(msg){
            "use strict";
            if(msg == undefined){
                msg = '';
            }
            $('#aguarde_msg').html(msg);
            $('#tela_aguarde').css('display', 'block');
        }

        function esconde_tela_aguarde(){
            "use strict";
            $('#tela_aguarde').css('display', 'none');
        }
  </script>
</head>
<body>
    <div id="tela_aguarde" class="mostra_tela">
        <div class="cont_anima">
            <div class="spinner-border" role="status">
<!--              <img src="includes/media/loading-fb.gif"/>-->
            </div>

            <p id="aguarde_msg"></p>
        </div>
    </div>

    <div class="row execution">
        <div class="col-8">
            <p id="question">1 - Faça uma programa que leia dois valores, realize a soma dos valores lidos e escreva o resultado.</p>
        </div>
        <div class="col-2 button">
            <button type="button" class="btn btn-light" id="button1" hidden></button>
        </div>
        <div class="col-2 button">
            <button type="button" class="btn" id="button5" hidden>Próximo passo</button>
            <button type="button" class="btn" id="button4" onclick="compiler(true)"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#5f6368"><path d="M480-200q66 0 113-47t47-113v-160q0-66-47-113t-113-47q-66 0-113 47t-47 113v160q0 66 47 113t113 47Zm-80-120h160v-80H400v80Zm0-160h160v-80H400v80Zm80 40Zm0 320q-65 0-120.5-32T272-240H160v-80h84q-3-20-3.5-40t-.5-40h-80v-80h80q0-20 .5-40t3.5-40h-84v-80h112q14-23 31.5-43t40.5-35l-64-66 56-56 86 86q28-9 57-9t57 9l88-86 56 56-66 66q23 15 41.5 34.5T688-640h112v80h-84q3 20 3.5 40t.5 40h80v80h-80q0 20-.5 40t-3.5 40h84v80H688q-32 56-87.5 88T480-120Z"/></svg></button>
            <button type="button" class="btn btn-success" id="button2" onclick="compiler()">Executar</button>
            <button type="button" class="btn btn-light" id="button3" onclick="cancelarExecucao = true" title="Cancelar execução" hidden>Cancelar</button>
        </div>
    </div>

    <div class="row text-editor">
        <!-- O elemento textarea que será transformado pelo CodeMirror -->
        <textarea id="code" style="height: 500px">
// Compilador WebAlgo Web
int main(){
    // Desenvolva seu código C aqui!
&#9;
&#9;
    return 0;
}</textarea>
    </div>

    <div class="row console">
        <div class="col-6 text-console">
            <textarea tabindex="-1" id="displayText" rows="8" readonly></textarea>
            <br>
            <input tabindex="0" type="text" id="inputText" disabled placeholder="">
        </div>
        <div class="col-2 text-console"></div>
        <div class="col-4 table-container" style="text-align: right">
            <a href="#" onclick="carrega_historico_variaveis();">Exibir histórico de variáveis</a>
            <table class="table table-sm" id="tabela_variaveis">
              <thead class="thead-dark">
                <tr>
                  <th scope="col" style="text-align: center">#</th>
                  <th scope="col">Variável</th>
                  <th scope="col" style="text-align: right; padding-right: 15px;">Valor</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <th scope="row">&nbsp;</th>
                  <td>&nbsp;</td>
                  <td>&nbsp;</td>
                </tr>
                <tr>
                  <th scope="row">&nbsp;</th>
                  <td>&nbsp;</td>
                  <td>&nbsp;</td>
                </tr>
                <tr>
                  <th scope="row">&nbsp;</th>
                  <td>&nbsp;</td>
                  <td>&nbsp;</td>
                </tr>
                <tr>
                  <th scope="row">&nbsp;</th>
                  <td>&nbsp;</td>
                  <td>&nbsp;</td>
                </tr>
                <tr>
                  <th scope="row">&nbsp;</th>
                  <td>&nbsp;</td>
                  <td>&nbsp;</td>
                </tr>
                <tr>
                  <th scope="row">&nbsp;</th>
                  <td>&nbsp;</td>
                  <td>&nbsp;</td>
                </tr>
                <tr>
                  <th scope="row">&nbsp;</th>
                  <td>&nbsp;</td>
                  <td>&nbsp;</td>
                </tr>
              </tbody>
            </table>
        </div>
    </div>

    <!-- Inclua o script do CodeMirror -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.1/codemirror.min.js"></script>
    <!-- Inclua os modos desejados (no exemplo, C) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.1/mode/clike/clike.min.js"></script>
    <!-- Inclua o complemento para preenchimento automático de chaves -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.1/addon/edit/closebrackets.min.js"></script>
    <!-- Addon for Autocomplete -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.1/addon/hint/show-hint.min.js"></script>
    <!-- Addon for C Hinting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.1/addon/hint/anyword-hint.min.js"></script>
    <!-- Bootstrap 5.3.3 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <!-- Arquivo JS do programa -->
    <script src="includes/js/main.js"></script>
    <!-- Arquivo JS do programa léxico -->
    <script src="includes/js/clexico.js"></script>
    <!-- Arquivo JS do programa sintático -->
    <script src="includes/js/csintatico.js"></script>
    <!-- Arquivo JS do programa maquina virtual para execução do C3E -->
    <script src="includes/js/maquina_virtual.js"></script>

    <div class="modal fade" id="modal_historico_variaveis" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Histórico de Variáveis</h5>
          </div>
          <div class="modal-body">
            <table class="table" id="tabela_historico_variaveis_modal">
              <thead class="thead-dark">
                <tr>
                  <th scope="col" style="text-align: center">#</th>
                  <th scope="col">Variável</th>
                  <th scope="col" colspan="100%" style="text-align: right; padding-right: 15px;">Histórico (do mais antigo para o mais recente)</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <th scope="row">&nbsp;</th>
                  <td>&nbsp;</td>
                  <td>&nbsp;</td>
                </tr>
                <tr>
                  <th scope="row">&nbsp;</th>
                  <td>&nbsp;</td>
                  <td>&nbsp;</td>
                </tr>
                <tr>
                  <th scope="row">&nbsp;</th>
                  <td>&nbsp;</td>
                  <td>&nbsp;</td>
                </tr>
                <tr>
                  <th scope="row">&nbsp;</th>
                  <td>&nbsp;</th>
                  <td>&nbsp;</th>
                </tr>
                <tr>
                  <th scope="row">&nbsp;</th>
                  <td>&nbsp;</td>
                  <td>&nbsp;</td>
                </tr>
                <tr>
                  <th scope="row">&nbsp;</th>
                  <td>&nbsp;</td>
                  <td>&nbsp;</td>
                </tr>
                <tr>
                  <th scope="row">&nbsp;</th>
                  <td>&nbsp;</td>
                  <td>&nbsp;</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="fecha_modal('modal_historico_variaveis')">Fechar</button>
          </div>
        </div>
      </div>
    </div>


    <script>

        // Função para salvar os dados no localStorage
        function saveDataAndReload() {
            const codigo_fonte = editor.getValue();
            localStorage.setItem('codigo_fonte', codigo_fonte);
            localStorage.setItem('compilar', true);
            location.reload();
        }

        // Função para restaurar os dados do localStorage
        function restoreData() {
            const codigo_fonte = localStorage.getItem('codigo_fonte');
            const compilar = localStorage.getItem('compilar');
            editor.setValue(codigo_fonte);
            if (compilar === 'true'){
                compiler();
            }
        }
        window.onload = restoreData;

        function fecha_modal(id_modal){
            $("#" + id_modal).modal('hide');
        }

        // Inicialize o CodeMirror no textarea com o ID "code"
        var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
            lineNumbers: true, // Mostrar números de linha
            mode: "text/x-csrc", // Definir o modo do editor como C
            theme: "dracula", // Escolher o tema do editor
            autoCloseBrackets: true, // Ativar o preenchimento automático de chaves
            indentUnit: 4, // Definir o número de espaços em branco para a tecla Tab e para o recuo
            tabSize: 4, // Definir o tamanho do Tab como quatro espaços em branco
            height: "30em", // Definir a altura do editor para 30 linhas
            extraKeys: { "Ctrl-Space": "autocomplete" } // Trigger autocomplete
        });
        editor.setSize(null, 400);

        // Captura o elemento input e textarea
        var inputElement = document.getElementById('inputText');
        var textareaElement = document.getElementById('displayText');

        // Adiciona um listener para o evento keypress
        // inputElement.addEventListener('keypress', function(event) {
        //     // Verifica se a tecla pressionada é Enter (código 13)
        //     if (event.keyCode === 13 && inputElement.value !== '') {
        //         // Adiciona o valor digitado ao textarea
        //         textareaElement.value += inputElement.value + '\n';
        //         // Limpa o input
        //         inputElement.value = '';
        //         // Rola o textarea para o final
        //         textareaElement.scrollTop = 100000000;
        //     }
        // });

        // Provide hinting for C
        CodeMirror.registerHelper("hint", "c", function(editor) {
            var completions = [
                "break", "case", "char", "continue", "do", "double", "else",
                "float", "for", "goto", "if", "int", "long", "return",
                "sizeof", "switch", "void", "while"
            ];
            var cur = editor.getCursor();
            var token = editor.getTokenAt(cur);
            var start = token.start, end = cur.ch;
            var prefix = token.string;
            var list = completions.filter(function(completion) {
                return completion.startsWith(prefix);
            });
            return { list: list, from: CodeMirror.Pos(cur.line, start), to: CodeMirror.Pos(cur.line, end) };
        });

        // Função para alternar breakpoint em uma linha
        function toggleBreakpoint(line) {
            var info = editor.lineInfo(line);
            if (info.text.replace(' ', '') !== '') {
                if (!info.gutterMarkers) {
                    editor.setGutterMarker(line, "CodeMirror-linenumbers", makeMarker());
                } else {
                    editor.setGutterMarker(line, "CodeMirror-linenumbers", null);
                }
            }
        }

        // Função para criar um marcador de breakpoint
        function makeMarker() {
            var marker = document.createElement("div");
            marker.style.color = "#822";
            marker.innerHTML = "●";
            return marker;
        }

        // Ouvinte de evento para clicar na gutter (área do número de linha)
        editor.on("gutterClick", function(cm, line, gutter) {
            console.log(gutter);
            if (gutter === "CodeMirror-linenumbers") {
                toggleBreakpoint(line);
            }
        });

        document.getElementById('inputText').addEventListener('input', function (e) {
          // Expressão regular para permitir apenas números, ponto e sinal negativo
          const validPattern = /^-?[0-9]*\.?[0-9]*$/;

          // Verifica se o valor atual é válido
          if (!validPattern.test(this.value)) {
            // Remove o último caractere se não for válido
            this.value = this.value.slice(0, -1);
          }

          // Evita múltiplos pontos consecutivos, múltiplos sinais negativos, ou ponto após o sinal negativo
          const firstChar = this.value.charAt(0);
          if ((this.value.match(/\./g) || []).length > 1 || (this.value.match(/-/g) || []).length > 1 || (firstChar === '-' && this.value.charAt(1) === '.')) {
            this.value = this.value.slice(0, -1);
          }
        });

        function addLineDecoration(line, className) {
            editor.addLineClass(line, 'wrap', className);
          }
    </script>
</body>
</html>